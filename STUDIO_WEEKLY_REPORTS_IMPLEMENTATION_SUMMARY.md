# Studio Insights & Weekly Reports Implementation Summary

## Overview

Implemented automated weekly reports that analyze social media performance and provide actionable insights and recommendations. Reports are generated by LLM using metrics data and brand profile context.

## What Changed

### 1. Schema

**Migration**: `supabase/migrations/20250127000000_studio_reports_schema.sql`

**Table Created**: `studio_reports`

- `id` (UUID, primary key)
- `workspace_id` (UUID, foreign key to workspaces)
- `period_start` (TIMESTAMPTZ) - Start of reporting period (typically Monday)
- `period_end` (TIMESTAMPTZ) - End of reporting period (typically Sunday)
- `summary_markdown` (TEXT) - LLM-generated markdown report
- `created_at` (TIMESTAMPTZ)
- `created_by` (UUID, foreign key to auth.users)

**Constraints**:
- Unique constraint: `(workspace_id, period_start, period_end)` - Prevents duplicate reports for same period

**Indexes**:
- `idx_studio_reports_workspace_id` - For workspace queries
- `idx_studio_reports_period` - For date range queries (workspace_id, period_start DESC, period_end DESC)

**RLS Policies**:
- Workspace members can view their reports
- Workspace members can insert reports (for manual generation)

### 2. Report Generation Service

**File**: `lib/studio/report-service.ts`

Created service functions:

- **`generateWeeklyReport(workspaceId, periodStart?, periodEnd?, userId?)`**:
  - Determines period (defaults to last week, Monday to Sunday)
  - Checks for existing report (returns if found)
  - Fetches metrics for current period via `fetchPeriodMetrics()`
  - Calculates deltas vs previous period via `calculateDeltas()`
  - Fetches brand profile
  - Determines if "getting started" report (sparse metrics)
  - Calls LLM with comprehensive context
  - Saves report to database
  - Returns report object

- **`fetchPeriodMetrics(workspaceId, periodStart, periodEnd, supabase)`**:
  - Fetches posts with metrics for period
  - Calculates totals (posts, impressions, views, likes, comments, shares, saves)
  - Calculates average engagement rate
  - Identifies top 3 posts by engagement rate
  - Returns `ReportMetrics` object

- **`calculateDeltas(workspaceId, currentPeriod, periodStart, periodEnd, supabase)`**:
  - Calculates previous period (same length, one period before)
  - Fetches previous period metrics
  - Returns deltas (posts, impressions, engagement_rate)
  - Returns undefined if no previous data

- **`getWorkspaceReports(workspaceId, limit)`**:
  - Fetches recent reports for workspace
  - Ordered by period_start DESC

- **`getReport(reportId)`**:
  - Fetches specific report by ID

**LLM Prompt Structure**:

**System Prompt**:
```
You are a social media analytics expert and content strategist. Your job is to write clear, actionable weekly reports that help brands understand their social media performance and improve.

Write in plain, conversational language. Be specific and actionable. Focus on:
1. What worked (top posts, successful strategies)
2. What didn't work (underperforming content, missed opportunities)
3. What to do next week (specific recommendations)

Use markdown formatting for readability.
```

**User Prompt** (varies based on data availability):
- For sparse data: "Getting started" style report
- For full data: Includes metrics, deltas, top posts, brand profile
- Always requests: Week at a Glance, What Worked, What Didn't Work, Recommendations

### 3. Cron Job

**File**: `app/api/cron/studio/weekly-report/route.ts`

Created `GET /api/cron/studio/weekly-report` endpoint:

- **Security**: Verifies cron secret (if configured)
- **Single Workspace Mode**: If `workspace_id` query param provided, generates report for that workspace only
- **All Workspaces Mode**: If no workspace_id, iterates over all workspaces and generates reports
- **Error Handling**: Per-workspace error handling (one failure doesn't stop others)
- **Response**: Returns summary of generated reports

**Vercel Cron Configuration** (`vercel.json`):
- Added cron job: `"0 9 * * 1"` (Every Monday at 9 AM)
- Path: `/api/cron/studio/weekly-report`

### 4. API Endpoints

**File**: `app/api/studio/reports/route.ts`

- **GET `/api/studio/reports`**:
  - Lists reports for workspace
  - Query param: `limit` (default: 10)
  - Returns array of reports ordered by period_start DESC

- **POST `/api/studio/reports`**:
  - Generates new report
  - Body: `{ period_start?, period_end? }` (optional, defaults to last week)
  - Returns generated report

**File**: `app/api/studio/reports/[reportId]/route.ts`

- **GET `/api/studio/reports/[reportId]`**:
  - Fetches specific report by ID
  - Verifies workspace ownership
  - Returns report object

### 5. UI

**File**: `app/studio/reports/page.tsx`

Created Reports page with:

- **Header**:
  - Title and description
  - "Generate Report" button (manual trigger)

- **Two-Column Layout**:
  - **Left Column**: Reports list
    - Shows all reports with period dates
    - Highlights selected report
    - Click to view report
    - Empty state when no reports
  
  - **Right Column**: Report view
    - Shows selected report
    - Renders markdown content
    - Displays period and generation date
    - Empty state when no report selected

- **Features**:
  - Loading states
  - Error handling
  - Markdown rendering (basic support for headers, lists, paragraphs, bold)
  - Responsive design

## Files Created

1. `supabase/migrations/20250127000000_studio_reports_schema.sql` - Database schema
2. `lib/studio/report-service.ts` - Report generation service
3. `app/api/cron/studio/weekly-report/route.ts` - Cron job endpoint
4. `app/api/studio/reports/route.ts` - Reports list/create API
5. `app/api/studio/reports/[reportId]/route.ts` - Report detail API
6. `app/studio/reports/page.tsx` - Reports UI page
7. `STUDIO_WEEKLY_REPORTS_IMPLEMENTATION_SUMMARY.md` - This file

## Files Modified

1. `vercel.json` - Added weekly report cron job

## Data Flow

### Metrics → Report Generation

1. **Period Determination**:
   - Default: Last week (Monday to Sunday)
   - Can be customized via API

2. **Metrics Collection**:
   - Fetch posts with metrics for period
   - Calculate totals and averages
   - Identify top performers
   - Calculate deltas vs previous period

3. **Context Building**:
   - Brand profile (if available)
   - Metrics summary
   - Top posts with performance data
   - Deltas (if previous period exists)

4. **LLM Generation**:
   - System prompt defines role and style
   - User prompt includes all context
   - Model generates markdown report
   - Sections: Week at a Glance, What Worked, What Didn't Work, Recommendations

5. **Storage**:
   - Report saved to `studio_reports` table
   - Unique constraint prevents duplicates
   - Can be retrieved later

### Report Retrieval

1. **List Reports**: Query by workspace_id, ordered by period_start DESC
2. **View Report**: Fetch by ID, verify workspace ownership
3. **Render**: Display markdown content in UI

## API Endpoints

### GET /api/studio/reports

**Query Parameters**:
- `limit` (optional, default: 10) - Number of reports to return

**Response**:
```json
{
  "ok": true,
  "data": {
    "reports": [
      {
        "id": "uuid",
        "workspace_id": "uuid",
        "period_start": "2024-01-15T00:00:00Z",
        "period_end": "2024-01-21T23:59:59Z",
        "summary_markdown": "# Week at a Glance...",
        "created_at": "2024-01-22T09:00:00Z",
        "created_by": "uuid"
      }
    ]
  }
}
```

### POST /api/studio/reports

**Request Body**:
```json
{
  "period_start": "2024-01-15T00:00:00Z", // Optional
  "period_end": "2024-01-21T23:59:59Z"   // Optional
}
```

**Response**:
```json
{
  "ok": true,
  "data": {
    "report": { ... }
  }
}
```

### GET /api/studio/reports/[reportId]

**Response**:
```json
{
  "ok": true,
  "data": {
    "report": { ... }
  }
}
```

### GET /api/cron/studio/weekly-report

**Query Parameters**:
- `secret` (required if CRON_SECRET configured)
- `workspace_id` (optional) - Generate for single workspace

**Response**:
```json
{
  "ok": true,
  "message": "Generated reports for X workspaces",
  "summary": {
    "total": 10,
    "success": 9,
    "failed": 1
  },
  "details": [...]
}
```

## Key Features

### 1. Automatic Generation
- Cron job runs weekly (Monday 9 AM)
- Generates reports for all workspaces
- Prevents duplicates (unique constraint)

### 2. Manual Trigger
- "Generate Report" button in UI
- API endpoint for programmatic generation
- Can specify custom period

### 3. Getting Started Reports
- Detects sparse metrics (< 5 posts or no impressions)
- Generates shorter, encouraging report
- Provides general best practices
- Sets expectations

### 4. Performance Analysis
- Calculates deltas vs previous period
- Identifies top performing posts
- Provides context for recommendations

### 5. Brand-Aware
- Includes brand profile in prompts
- Recommendations align with brand voice
- Contextual insights

## Constraints Met

✅ **Sparse metrics handling**: Generates "getting started" style reports  
✅ **Brand profile context**: Always included in LLM prompts  
✅ **Metrics summary**: Comprehensive context provided  
✅ **Workspace scoping**: All reports workspace-scoped  
✅ **Duplicate prevention**: Unique constraint on period  

## UI Entry Points

1. **Reports Page** (`/studio/reports`):
   - View all reports
   - Select and view specific report
   - Generate new report manually

2. **Future Integration Points** (not yet implemented):
   - Link from Studio dashboard
   - Email notifications when reports are generated
   - Export reports (PDF, email)

## Follow-up Ideas

### Short-term Enhancements

1. **Email Notifications**:
   - Send report via email when generated
   - Weekly digest option
   - Customizable recipients

2. **Report Export**:
   - Export as PDF
   - Export as markdown file
   - Share via link

3. **Comparison Views**:
   - Compare multiple periods side-by-side
   - Trend visualization
   - Performance charts

### Medium-term Enhancements

1. **Customizable Reports**:
   - User-defined sections
   - Custom metrics to include
   - Report templates

2. **Scheduled Reports**:
   - Custom schedules per workspace
   - Different report types (daily, weekly, monthly)
   - Automated delivery

3. **Interactive Insights**:
   - Click to drill down into metrics
   - Link to top posts
   - Action items with tracking

### Long-term Vision

1. **Predictive Insights**:
   - Forecast next week's performance
   - Identify trends early
   - Proactive recommendations

2. **Multi-Platform Comparison**:
   - Compare performance across platforms
   - Cross-platform insights
   - Unified recommendations

3. **AI-Powered Actions**:
   - Auto-generate content based on recommendations
   - Schedule posts from insights
   - Implement suggestions automatically

## Testing Recommendations

1. **Unit Tests**:
   - Test `fetchPeriodMetrics()` with various data
   - Test `calculateDeltas()` logic
   - Test markdown generation

2. **Integration Tests**:
   - Test full report generation flow
   - Test with sparse metrics
   - Test duplicate prevention
   - Test cron job execution

3. **E2E Tests**:
   - Test UI report viewing
   - Test manual report generation
   - Test report list and selection

## Performance Considerations

- Report generation is async and doesn't block UI
- Metrics queries use indexes for fast lookups
- LLM calls are efficient (single call per report)
- Reports are cached (unique constraint prevents regeneration)

## Security Considerations

- RLS policies enforce workspace boundaries
- All queries filtered by workspace_id
- Cron secret prevents unauthorized access
- User authentication required for API endpoints

## Next Steps

1. **Test the implementation**:
   - Generate reports for test workspaces
   - Verify markdown rendering
   - Test cron job execution

2. **Monitor report quality**:
   - Review generated reports
   - Refine prompts based on output
   - Collect user feedback

3. **Add navigation**:
   - Link to reports from Studio dashboard
   - Add to Studio navigation menu
   - Improve discoverability

4. **Enhance UI**:
   - Better markdown rendering (consider react-markdown library)
   - Report preview/export
   - Comparison views

